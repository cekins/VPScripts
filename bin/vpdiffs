#!/bin/bash

# TODO: desc

# Import functions
libDir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )/../lib/"
source ${libDir}functions.sh

# Extra variables
helpMessage="Script for creating and comparing verification points.\n\nOptions:\n\t-h  help\n\t-c  convert\n\t-d difference"

# Colors
RED='\e[0;31m'
GRN='\e[0;32m'
BLU='\e[0;34m'
BLD='\e[1m'
NC='\e[0m'

HED=$BLU$BLD

# Check for flags
convertVP=false
diffVP=false
while getopts "hcd" argOpts
do
	case $argOpts in
		h)
			printf "$helpMessage"
			exit 0
			;;
		c)
			convertVP=true
			;;
		d)	
			diffVP=true
			;;
	esac
done

# Initialized Variables
generatedVPs=()

# Print extra space to separate command output
printf "\n"

# Get screenshot directory
ssDir=$(getScreenshotDir)

# Iterate over screenshots in folder
for ssFile in $(ls "$ssDir")
do
	# Extract vp name from each screenshot
	vpName=$(getVPName $ssFile)
	vpDir=$(getVPDir)

	# Get matching vp files and sort them 
	matchingVPs=$(getMatchingVPs $vpName)
	matchingVPs=($(sort <<<"$matchingVPs"))

	# Check if screenshot has corresponding vp
	if [[ ${#matchingVPs[@]} != 0 ]]; then
		# Print base name of vp
		printf "${HED}%s${NC}:\n\n" "${vpName}"
	fi

	for vpFile in "${matchingVPs[@]}"
	do
		# Run comparison command
		output=$(/opt/squish-6.4/bin/testvp --image "$vpFile" "junk" "$ssDir$ssFile")

		# Test output to determine display color
		if [[ $output == *"match"* ]]; then
			
			CLR=$GRN
		else
			CLR=$RED
		fi
		
		# Print comparison outpu
		printf "\t${CLR}%s\n\t%s${NC}\n\n" "${vpFile#${vpDir}}" "${output}"

		if $diffVP; then
			# Run visual comparison
			/opt/squish-6.4/bin/vpdiff "$vpFile" "junk" "$ssDir$ssFile"
		fi	
	done

	# Check if screenshot corresponds to verification points
	if  $convertVP  && [[ -n $matchingVPs ]]
	then

		# Determine name for new vp 
		highestVP=${matchingVPs[-1]}

		# Check if string has underscore end
		if [[ $highestVP =~ .*_[0-9]+$ ]]; then
			newNumber=$((${highestVP##*_} + 1))
		else
			newNumber=1
		fi

		# Create new vp name
		newVP="${matchingVPs[0]}_$newNumber"


		# Prompt user for conversion
		prompt="(G)enerate ${newVP##*/}\n(V)isual Compare\n(N)ext VP\n"

		printf "$prompt"
		while true; do
			read -p "(g/v/n)?"  op 
			case $op in 
				[Gg]* ) # Generate new vp
					/opt/squish-6.4/bin/convertvp --tovp "$newVP" "$ssDir$ssFile" "WIDGET_NAME_PLACEHOLDER"

					# Add generated vp to list
					generatedVPs+=("${newVP##*/}")
					;;

				[Vv]* ) # #Visual comparison
					for vpFile in "${matchingVPs[@]}"
					do
						# Run visual comparison
						/opt/squish-6.4/bin/vpdiff "$vpFile" "junk" "$ssDir$ssFile"
					done
					;;

				[Nn]* ) # Next VP
					break
					;;

				* ) # Invalid command
					;;

			esac
		done
		printf "\n"
	fi	
done

# List created vps

if [[ ${#generatedVPs[@]} != 0 ]]; then
	printf "${BLD}%s${NC}\n" "Generated VPs:" 
	printf "\t%s\n" "${generatedVPs[@]}"
fi
